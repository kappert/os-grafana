{"version":3,"sources":["../src/datasource.js"],"names":["_","Variables","Capabilities","QueryProcessor","HawkularDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","headers","jsonData","tenant","basicAuth","length","token","typeResources","variables","capabilitiesPromise","queryVersion","then","version","queryProcessor","options","validTargets","targets","filter","target","hide","queryBy","tags","when","data","promises","map","run","all","flatten","concat","apply","responses","sort","m1","m2","localeCompare","datasourceRequest","method","response","status","message","title","start","range","from","valueOf","end","to","order","ids","annotation","query","annot","time","dp","timestamp","undefined","text","value","key","hasOwnProperty","push","replace","join","result","m","id","params","substr","findTags","trim","charAt","metric","pattern","flatTags","property","tag","catch"],"mappings":";;;;;;;;;;;;;;;AAAOA,O;;AACCC,e,cAAAA,S;;AACAC,kB,iBAAAA,Y;;AACAC,oB,mBAAAA,c;;;;;;;;;;;;;;;;;;;;;oCAEKC,kB;AAEX,oCAAYC,gBAAZ,EAA8BC,EAA9B,EAAkCC,UAAlC,EAA8CC,WAA9C,EAA2D;AAAA;;AACzD,eAAKC,IAAL,GAAYJ,iBAAiBI,IAA7B;AACA,eAAKC,GAAL,GAAWL,iBAAiBK,GAA5B;AACA,eAAKC,IAAL,GAAYN,iBAAiBM,IAA7B;AACA,eAAKC,CAAL,GAASN,EAAT;AACA,eAAKC,UAAL,GAAkBA,UAAlB;AACA,eAAKM,OAAL,GAAe;AACb,4BAAgB,kBADH;AAEb,+BAAmBR,iBAAiBS,QAAjB,CAA0BC;AAFhC,WAAf;AAIA,cAAI,OAAOV,iBAAiBW,SAAxB,KAAsC,QAAtC,IAAkDX,iBAAiBW,SAAjB,CAA2BC,MAA3B,GAAoC,CAA1F,EAA6F;AAC3F,iBAAKJ,OAAL,CAAa,eAAb,IAAgCR,iBAAiBW,SAAjD;AACD,WAFD,MAEO,IAAI,OAAOX,iBAAiBS,QAAjB,CAA0BI,KAAjC,KAA2C,QAA3C,IAAuDb,iBAAiBS,QAAjB,CAA0BI,KAA1B,CAAgCD,MAAhC,GAAyC,CAApG,EAAuG;AAC5G,iBAAKJ,OAAL,CAAa,eAAb,IAAgC,YAAYR,iBAAiBS,QAAjB,CAA0BI,KAAtE;AACD;AACD,eAAKC,aAAL,GAAqB;AACnB,qBAAS,QADU;AAEnB,uBAAW,UAFQ;AAGnB,4BAAgB;AAHG,WAArB;AAKA,cAAIC,YAAY,IAAInB,SAAJ,CAAcO,WAAd,CAAhB;AACA,eAAKa,mBAAL,GAA2B,KAAKC,YAAL,GACxBC,IADwB,CACnB;AAAA,mBAAW,IAAIrB,YAAJ,CAAiBsB,OAAjB,CAAX;AAAA,WADmB,CAA3B;AAEA,eAAKC,cAAL,GAAsB,IAAItB,cAAJ,CAAmBG,EAAnB,EAAuBC,UAAvB,EAAmCa,SAAnC,EAA8C,KAAKC,mBAAnD,EAAwE,KAAKX,GAA7E,EAAkF,KAAKG,OAAvF,EAAgG,KAAKM,aAArG,CAAtB;AACD;;;;gCAEKO,O,EAAS;AAAA;;AACb,gBAAIC,eAAeD,QAAQE,OAAR,CAChBC,MADgB,CACT;AAAA,qBAAU,CAACC,OAAOC,IAAlB;AAAA,aADS,EAEhBF,MAFgB,CAET;AAAA,qBAAWC,OAAOE,OAAP,KAAmB,MAAnB,IAA6BF,OAAOG,IAAP,CAAYhB,MAAZ,GAAqB,CAAnD,IAAyDa,OAAOA,MAAP,KAAkB,eAArF;AAAA,aAFS,CAAnB;;AAIA,gBAAIH,aAAaV,MAAb,KAAwB,CAA5B,EAA+B;AAC7B,qBAAO,KAAKL,CAAL,CAAOsB,IAAP,CAAY,EAACC,MAAM,EAAP,EAAZ,CAAP;AACD;;AAED,gBAAIC,WAAWT,aAAaU,GAAb,CAAiB,kBAAU;AACxC,qBAAO,MAAKZ,cAAL,CAAoBa,GAApB,CAAwBR,MAAxB,EAAgCJ,OAAhC,CAAP;AACD,aAFc,CAAf;;AAIA,mBAAO,KAAKd,CAAL,CAAO2B,GAAP,CAAWH,QAAX,EAAqBb,IAArB,CAA0B,qBAAa;AAC5C,kBAAIiB,UAAU,GAAGC,MAAH,CAAUC,KAAV,CAAgB,EAAhB,EAAoBC,SAApB,EACXC,IADW,CACN,UAASC,EAAT,EAAaC,EAAb,EAAiB;AACrB,uBAAOD,GAAGf,MAAH,CAAUiB,aAAV,CAAwBD,GAAGhB,MAA3B,CAAP;AACD,eAHW,CAAd;AAIA,qBAAO,EAACK,MAAMK,OAAP,EAAP;AACD,aANM,CAAP;AAOD;;;2CAEgB;AACf,mBAAO,KAAKjC,UAAL,CAAgByC,iBAAhB,CAAkC;AACvCtC,mBAAK,KAAKA,GAAL,GAAW,UADuB;AAEvCuC,sBAAQ,KAF+B;AAGvCpC,uBAAS,KAAKA;AAHyB,aAAlC,EAIJU,IAJI,CAIC,oBAAY;AAClB,kBAAI2B,SAASC,MAAT,KAAoB,GAApB,IAA2BD,SAASC,MAAT,KAAoB,GAAnD,EAAwD;AACtD,uBAAO,EAAEA,QAAQ,SAAV,EAAqBC,SAAS,wBAA9B,EAAwDC,OAAO,SAA/D,EAAP;AACD,eAFD,MAEO;AACL,uBAAO,EAAEF,QAAQ,OAAV,EAAmBC,SAAS,wBAAwBF,SAASC,MAAjC,GAA0C,GAAtE,EAA2EE,OAAO,OAAlF,EAAP;AACD;AACF,aAVM,CAAP;AAWD;;;0CAEe3B,O,EAAS;AACvB,mBAAO,KAAKnB,UAAL,CAAgByC,iBAAhB,CAAkC;AACvCtC,mBAAK,KAAKA,GAAL,GAAW,oBADuB;AAEvCyB,oBAAM;AACJmB,uBAAO5B,QAAQ6B,KAAR,CAAcC,IAAd,CAAmBC,OAAnB,EADH;AAEJC,qBAAKhC,QAAQ6B,KAAR,CAAcI,EAAd,CAAiBF,OAAjB,EAFD;AAGJG,uBAAO,KAHH;AAIJC,qBAAK,CAACnC,QAAQoC,UAAR,CAAmBC,KAApB;AAJD,eAFiC;AAQvCd,sBAAQ,MAR+B;AASvCpC,uBAAS,KAAKA;AATyB,aAAlC,EAUJU,IAVI,CAUC;AAAA,qBAAY2B,SAASC,MAAT,IAAmB,GAAnB,GAAyBD,SAASf,IAAT,CAAc,CAAd,EAAiBA,IAA1C,GAAiD,EAA7D;AAAA,aAVD,EAWNZ,IAXM,CAWD;AAAA,qBAAQY,KAAKE,GAAL,CAAS,cAAM;AAC3B,oBAAI2B,QAAQ;AACVF,8BAAYpC,QAAQoC,UADV;AAEVG,wBAAMC,GAAGC,SAFC;AAGVd,yBAAO3B,QAAQoC,UAAR,CAAmBnD,IAHhB;AAIVsB,wBAAMmC,SAJI;AAKVC,wBAAMH,GAAGI;AALC,iBAAZ;AAOA,oBAAIJ,GAAGjC,IAAP,EAAa;AACX,sBAAIA,OAAO,EAAX;AACA,uBAAK,IAAIsC,GAAT,IAAgBL,GAAGjC,IAAnB,EAAyB;AACvB,wBAAIiC,GAAGjC,IAAH,CAAQuC,cAAR,CAAuBD,GAAvB,CAAJ,EAAiC;AAC/BtC,2BAAKwC,IAAL,CAAUP,GAAGjC,IAAH,CAAQsC,GAAR,EAAaG,OAAb,CAAqB,GAArB,EAA0B,GAA1B,CAAV;AACD;AACF;AACD,sBAAIzC,KAAKhB,MAAL,GAAc,CAAlB,EAAqB;AACnB+C,0BAAM/B,IAAN,GAAaA,KAAK0C,IAAL,CAAU,GAAV,CAAb;AACD;AACF;AACD,uBAAOX,KAAP;AACD,eApBa,CAAR;AAAA,aAXC,CAAP;AAgCD;;;yCAEclC,M,EAAQ;AACrB,mBAAO,KAAKvB,UAAL,CAAgByC,iBAAhB,CAAkC;AACvCtC,mBAAK,KAAKA,GAAL,GAAW,gBAAX,GAA8BoB,OAAOrB,IADH;AAEvCwC,sBAAQ,KAF+B;AAGvCpC,uBAAS,KAAKA;AAHyB,aAAlC,EAIJU,IAJI,CAIC,kBAAU;AAChB,qBAAOqD,OAAOzC,IAAP,CAAYE,GAAZ,CAAgB;AAAA,uBAAKwC,EAAEC,EAAP;AAAA,eAAhB,EACJlC,IADI,GAEJP,GAFI,CAEA,cAAM;AACT,uBAAO,EAACgC,MAAMS,EAAP,EAAWR,OAAOQ,EAAlB,EAAP;AACD,eAJI,CAAP;AAKD,aAVM,CAAP;AAWD;;;sCAEWrE,I,EAAM8D,G,EAAK;AACrB,gBAAI,CAACA,GAAL,EAAU;AACR;AACA,qBAAO,KAAK3D,CAAL,CAAOsB,IAAP,CAAY,EAAZ,CAAP;AACD;AACD,mBAAO,KAAK3B,UAAL,CAAgByC,iBAAhB,CAAkC;AACvCtC,mBAAK,KAAKA,GAAL,GAAW,GAAX,GAAiB,KAAKS,aAAL,CAAmBV,IAAnB,CAAjB,GAA4C,QAA5C,GAAuD8D,GAAvD,GAA6D,IAD3B;AAEvCtB,sBAAQ,KAF+B;AAGvCpC,uBAAS,KAAKA;AAHyB,aAAlC,EAIJU,IAJI,CAIC,kBAAU;AAChB,kBAAIqD,OAAOzC,IAAP,CAAYqC,cAAZ,CAA2BD,GAA3B,CAAJ,EAAqC;AACnC,uBAAO,CAAC,IAAD,EAAO9B,MAAP,CAAcmC,OAAOzC,IAAP,CAAYoC,GAAZ,CAAd,EAAgClC,GAAhC,CAAoC,iBAAS;AAClD,yBAAO,EAACgC,MAAMC,KAAP,EAAcA,OAAOA,KAArB,EAAP;AACD,iBAFM,CAAP;AAGD;AACD,qBAAO,EAAP;AACD,aAXM,CAAP;AAYD;;;0CAEeP,K,EAAO;AACrB,gBAAIgB,SAAS,EAAb;AACA,gBAAIhB,UAAUK,SAAd,EAAyB;AACvB,kBAAIL,MAAMiB,MAAN,CAAa,CAAb,EAAgB,CAAhB,MAAuB,OAA3B,EAAoC;AAClC,uBAAO,KAAKC,QAAL,CAAclB,MAAMiB,MAAN,CAAa,CAAb,EAAgBE,IAAhB,EAAd,CAAP;AACD;AACD,kBAAInB,MAAMoB,MAAN,CAAa,CAAb,MAAoB,GAAxB,EAA6B;AAC3BJ,yBAAShB,KAAT;AACD,eAFD,MAEO;AACLgB,yBAAS,MAAMhB,KAAf;AACD;AACF;AACD,mBAAO,KAAKxD,UAAL,CAAgByC,iBAAhB,CAAkC;AACvCtC,mBAAK,KAAKA,GAAL,GAAW,UAAX,GAAwBqE,MADU;AAEvC9B,sBAAQ,KAF+B;AAGvCpC,uBAAS,KAAKA;AAHyB,aAAlC,EAIJU,IAJI,CAIC,kBAAU;AAChB,qBAAOvB,EAAEqC,GAAF,CAAMuC,OAAOzC,IAAb,EAAmB,kBAAU;AAClC,uBAAO,EAACkC,MAAMe,OAAON,EAAd,EAAkBR,OAAOc,OAAON,EAAhC,EAAP;AACD,eAFM,CAAP;AAGD,aARM,CAAP;AASD;;;mCAEQO,O,EAAS;AAChB,mBAAO,KAAK9E,UAAL,CAAgByC,iBAAhB,CAAkC;AACvCtC,mBAAK,KAAKA,GAAL,GAAW,gBAAX,GAA8B2E,OADI;AAEvCpC,sBAAQ,KAF+B;AAGvCpC,uBAAS,KAAKA;AAHyB,aAAlC,EAIJU,IAJI,CAIC,kBAAU;AAChB,kBAAI+D,WAAW,EAAf;AACA,kBAAIV,OAAOzC,IAAX,EAAiB;AACf,oBAAIA,OAAOyC,OAAOzC,IAAlB;AACA,qBAAK,IAAIoD,QAAT,IAAqBpD,IAArB,EAA2B;AACzB,sBAAIA,KAAKqC,cAAL,CAAoBe,QAApB,CAAJ,EAAmC;AACjCD,+BAAWA,SAAS7C,MAAT,CAAgBN,KAAKoD,QAAL,CAAhB,CAAX;AACD;AACF;AACF;AACD,qBAAOD,SAASjD,GAAT,CAAa,eAAO;AACzB,uBAAO,EAACgC,MAAMmB,GAAP,EAAYlB,OAAOkB,GAAnB,EAAP;AACD,eAFM,CAAP;AAGD,aAjBM,CAAP;AAkBD;;;yCAEc;AACb,mBAAO,KAAKjF,UAAL,CAAgByC,iBAAhB,CAAkC;AACvCtC,mBAAK,KAAKA,GAAL,GAAW,SADuB;AAEvCuC,sBAAQ,KAF+B;AAGvCpC,uBAAS,EAAC,gBAAgB,kBAAjB;AAH8B,aAAlC,EAIJU,IAJI,CAIC;AAAA,qBAAY2B,SAASf,IAAT,CAAc,wBAAd,CAAZ;AAAA,aAJD,EAKNsD,KALM,CAKA;AAAA,qBAAY,SAAZ;AAAA,aALA,CAAP;AAMD;;;4CAEiB;AAChB,mBAAO,KAAKpE,mBAAZ;AACD","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport {Variables} from './variables';\nimport {Capabilities} from './capabilities';\nimport {QueryProcessor} from './queryProcessor';\n\nexport class HawkularDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.headers = {\n      'Content-Type': 'application/json',\n      'Hawkular-Tenant': instanceSettings.jsonData.tenant\n    };\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    } else if (typeof instanceSettings.jsonData.token === 'string' && instanceSettings.jsonData.token.length > 0) {\n      this.headers['Authorization'] = 'Bearer ' + instanceSettings.jsonData.token;\n    }\n    this.typeResources = {\n      \"gauge\": \"gauges\",\n      \"counter\": \"counters\",\n      \"availability\": \"availability\"\n    };\n    let variables = new Variables(templateSrv);\n    this.capabilitiesPromise = this.queryVersion()\n      .then(version => new Capabilities(version));\n    this.queryProcessor = new QueryProcessor($q, backendSrv, variables, this.capabilitiesPromise, this.url, this.headers, this.typeResources);\n  }\n\n  query(options) {\n    let validTargets = options.targets\n      .filter(target => !target.hide)\n      .filter(target => (target.queryBy === 'tags' && target.tags.length > 0) || target.target !== 'select metric');\n\n    if (validTargets.length === 0) {\n      return this.q.when({data: []});\n    }\n\n    let promises = validTargets.map(target => {\n      return this.queryProcessor.run(target, options);\n    });\n\n    return this.q.all(promises).then(responses => {\n      let flatten = [].concat.apply([], responses)\n        .sort(function(m1, m2) {\n          return m1.target.localeCompare(m2.target);\n        });\n      return {data: flatten};\n    });\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics',\n      method: 'GET',\n      headers: this.headers\n    }).then(response => {\n      if (response.status === 200 || response.status === 204) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      } else {\n        return { status: \"error\", message: \"Connection failed (\" + response.status + \")\", title: \"Error\" };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/strings/raw/query',\n      data: {\n        start: options.range.from.valueOf(),\n        end: options.range.to.valueOf(),\n        order: 'ASC',\n        ids: [options.annotation.query]\n      },\n      method: 'POST',\n      headers: this.headers\n    }).then(response => response.status == 200 ? response.data[0].data : [])\n    .then(data => data.map(dp => {\n      var annot = {\n        annotation: options.annotation,\n        time: dp.timestamp,\n        title: options.annotation.name,\n        tags: undefined,\n        text: dp.value\n      };\n      if (dp.tags) {\n        var tags = [];\n        for (var key in dp.tags) {\n          if (dp.tags.hasOwnProperty(key)) {\n            tags.push(dp.tags[key].replace(' ', '_'));\n          }\n        }\n        if (tags.length > 0) {\n          annot.tags = tags.join(' ');\n        }\n      }\n      return annot;\n    }));\n  }\n\n  suggestQueries(target) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics?type=' + target.type,\n      method: 'GET',\n      headers: this.headers\n    }).then(result => {\n      return result.data.map(m => m.id)\n        .sort()\n        .map(id => {\n          return {text: id, value: id};\n        });\n    });\n  }\n\n  suggestTags(type, key) {\n    if (!key) {\n      // Need at least some characters typed in order to suggest something\n      return this.q.when([]);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/' + this.typeResources[type] + '/tags/' + key + ':*',\n      method: 'GET',\n      headers: this.headers\n    }).then(result => {\n      if (result.data.hasOwnProperty(key)) {\n        return [' *'].concat(result.data[key]).map(value => {\n          return {text: value, value: value};\n        });\n      }\n      return [];\n    });\n  }\n\n  metricFindQuery(query) {\n    var params = \"\";\n    if (query !== undefined) {\n      if (query.substr(0, 5) === \"tags/\") {\n        return this.findTags(query.substr(5).trim());\n      }\n      if (query.charAt(0) === '?') {\n        params = query;\n      } else {\n        params = \"?\" + query;\n      }\n    }\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics' + params,\n      method: 'GET',\n      headers: this.headers\n    }).then(result => {\n      return _.map(result.data, metric => {\n        return {text: metric.id, value: metric.id};\n      });\n    });\n  }\n\n  findTags(pattern) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/metrics/tags/' + pattern,\n      method: 'GET',\n      headers: this.headers\n    }).then(result => {\n      var flatTags = [];\n      if (result.data) {\n        var data = result.data;\n        for (var property in data) {\n          if (data.hasOwnProperty(property)) {\n            flatTags = flatTags.concat(data[property]);\n          }\n        }\n      }\n      return flatTags.map(tag => {\n        return {text: tag, value: tag};\n      });\n    });\n  }\n\n  queryVersion() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/status',\n      method: 'GET',\n      headers: {'Content-Type': 'application/json'}\n    }).then(response => response.data['Implementation-Version'])\n    .catch(response => \"Unknown\");\n  }\n\n  getCapabilities() {\n    return this.capabilitiesPromise;\n  }\n}\n"]}